From 6179ab02d23083a53478ff75aa9f285ba2217260 Mon Sep 17 00:00:00 2001
From: Grygorii Strashko <grygorii.strashko@ti.com>
Date: Fri, 9 Apr 2021 15:13:49 +0300
Subject: [PATCH 28/35] net: ethernet: ti: cpts: clean timer capture status

The DM Timer capture detection logic has to be reset or the
IRQSTATUS[2].TCAR_IT_FLAG is cleared by writing 1 to it otherwise no update
on the TCAR1 register and no interrupt triggering will happen after first
capture event. After commit "cpts: latch: disable tmr irq while latch is
on" the capture detection logic has not been reset when cpts_latch_proc()
is called from CPTS IRQ.

Fix it. (fix for NONADJUST)

Signed-off-by: Grygorii Strashko <grygorii.strashko@ti.com>
---
 drivers/net/ethernet/ti/cpts.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/net/ethernet/ti/cpts.c b/drivers/net/ethernet/ti/cpts.c
index a34d401580d5..bb29c25a9632 100644
--- a/drivers/net/ethernet/ti/cpts.c
+++ b/drivers/net/ethernet/ti/cpts.c
@@ -2038,6 +2038,7 @@ static u32 cpts_latch_proc(struct cpts *cpts)
 	u32 pps_latch_offset;
 
 	latch_cnt = READ_TCAP(cpts->odt2);
+	writel_relaxed(OMAP_TIMER_INT_CAPTURE, cpts->odt2->irq_stat);
 	offset = 0xFFFFFFFFUL - latch_cnt + 1;
 
 	pps_latch_offset = offset * CPTS_TMR_CLK_PERIOD +  CPTS_TMR_LATCH_DELAY;
-- 
2.17.1

